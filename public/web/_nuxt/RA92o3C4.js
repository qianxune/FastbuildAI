import{c as B}from"./D7VOTB3C.js";import{l as u,n as R,ai as F,j as J}from"#entry";const x=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,p=>{const v=Math.random()*16|0;return(p==="x"?v:v&3|8).toString(16)});function W(p={}){const{api:v,initialMessages:y=[],body:f={},onResponse:I,onUpdate:A,onError:C,onFinish:h,onToolCall:U,chatConfig:M}=p,a=u([...y]),g=u(""),c=u([]),s=u("idle"),d=u(null),r=u(null),D=R(()=>M||{}),k=e=>{a.value=[...e]},T=async e=>{const n={id:x(),...e,...e.role!=="user"&&!e.createdAt&&{createdAt:new Date().toISOString()}};a.value.push(n),e.role==="user"&&await b()},b=async()=>{if(s.value==="loading")return;s.value="loading",d.value=null;const e={id:x(),role:"assistant",content:"",status:"loading",mcpToolCalls:[],avatar:D.value.avatar,createdAt:new Date().toISOString()};a.value.push(e);try{const n=a.value.slice(0,-1).map(t=>({role:t.role,content:t.content})),l=v||B,m=JSON.parse(JSON.stringify({...f,modelId:f.modelId,conversationId:f.conversationId})),S=()=>{if(e.metadata?.reasoning?.startTime&&!e.metadata.reasoning.endTime){const t=Date.now();e.metadata.reasoning.endTime=t,e.metadata.reasoning.duration=t-e.metadata.reasoning.startTime}};r.value=await l(n,{body:m,onResponse:I,onUpdate(t){if(t.delta&&(S(),e.content+=t.delta,e.status="active",a.value=[...a.value]),t.type==="metadata"&&t.metadata){e.metadata||(e.metadata={});const{type:i,data:o}=t.metadata;switch(i){case"context":e.metadata.context=o;break;case"references":e.metadata.references=o;break;case"suggestions":e.metadata.suggestions=o;break;case"tokenUsage":e.metadata.tokenUsage=o;break;case"conversation_id":A?.({type:"conversation_id",data:o});break;case"annotations":e.metadata.annotations=o;break;case"reasoning":e.metadata.reasoning?e.metadata.reasoning.content+=o:e.metadata.reasoning={content:o,startTime:Date.now()};break;default:e.metadata[i]=o}a.value=[...a.value]}},onToolCall(t){const i=t.data;e.status="active",e.mcpToolCalls||(e.mcpToolCalls=[]);const o=e.mcpToolCalls.findIndex(j=>j.id===i.id);o!==-1?e.mcpToolCalls[o]=i:e.mcpToolCalls.push(i),U?.(i),a.value=[...a.value]},onFinish(t){e.status="completed",e.content=t.content||e.content,t.createdAt&&(e.createdAt=t.createdAt),S(),a.value=[...a.value],r.value=null,s.value="idle",h?.(e),J().getUser()},onError(t){if(t.message==="BodyStreamBuffer was aborted"){e.status="completed",s.value="idle";return}e.status="failed",e.content=t.message||e.content,a.value=[...a.value],r.value=null,s.value="error",d.value=t,C?.(t)}})}catch(n){const l=n instanceof Error?n:new Error(String(n));e.status="failed",a.value=[...a.value],r.value=null,s.value="error",d.value=l,C?.(l)}},E=async e=>{e&&typeof e=="object"&&"preventDefault"in e&&e.preventDefault();const n=typeof e=="string"?e:g.value.trim();if(!n&&!c.value.length||s.value==="loading")return;let l=n;if(c.value.length>0){const m=[...c.value];n&&m.push({type:"text",text:n}),l=m}g.value="",c.value=[],await T({id:x(),role:"user",content:l,status:"completed",mcpToolCalls:[]})},O=async()=>{if(a.value.length===0)return;s.value="idle",d.value=null;const e=a.value.map((n,l)=>({msg:n,index:l})).reverse().find(({msg:n})=>n.role==="user")?.index;e!==void 0&&(a.value=a.value.slice(0,e+1),await b())},w=()=>{if(r.value){r.value.abort(),r.value=null,s.value="idle";const e=a.value[a.value.length-1];e?.role==="assistant"&&(e.status="completed",a.value=[...a.value],h?.(e))}};return F(()=>w()),{messages:a,input:g,files:c,status:s,error:d,handleSubmit:E,reload:O,stop:w,setMessages:k,append:T}}export{W as u};
