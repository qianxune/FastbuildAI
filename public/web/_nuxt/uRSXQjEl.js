const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Crk5Dp68.js","./Cgyg1gJC.js","./4jjeIyfe.js","./D_3bTjYR.js","./D9sX2Qi6.js","./BFbGFa2O.js","./CBTz8tdX.js","./DMoqg0Fd.js","./CtosDvS0.js","./kRIii9yh.js","./DNSLGqNg.js","./Z7qkLoXK.js","./C6Y-ieo6.js","./BFo3vNrE.js","./DeCyaT7k.js","./D4e4FYoF.js","./BCcN9pii.js","./CMKSl-Ng.js","./CuVAPZQ8.js","./psimjGaX.js","./B3rWqoNg.js","./EK7Wbu3-.js","./BjKIBNOf.js","./9Q2Y_nd6.js","./td2xDKru.js","./BMSQkwth.js","./DaWZu8wl.js","./bvMLy1sv.js","./CAQVAH0V.js","./Deu6qIfg.js","./DD8ySyt7.js","./Ghlq83yM.js","./DQMjdCEn.js","./OUYfsp1i.js","./CjE5iPSn.js","./D9UsdH-b.js","./MCK2d4XT.js","./Dm8J87dm.js","./D2M85Dwf.js","./FTderXKt.js","./Bu9SiL2T.js","./Cie-o9Wa.js","./jsPNKUA0.js","./abPSHzII.js","./DlQqvcQS.js","./cd55qm53.js","./CvI6s-qz.js","./BstbYvQo.js"])))=>i.map(i=>d[i]);
import{d as ye,aM as ke,j as Q,i as Ce,at as be,k as we,aR as xe,V as Ie,n as z,s as E,p as N,aW as Fe,J as H,q as Se,ai as Ae,c,o as r,f as k,y as f,t as d,x as g,g as n,W as L,w as v,z as C,F as M,E as P,_ as Ee,B as Me,D as j,X as q,aZ as Re}from"#entry";import{_ as Ve}from"./vMXLMQMq.js";import{_ as $e,a as Be}from"./CMrwRwXe.js";import{_ as Ue}from"./shdu-Ndv.js";import{_ as Te}from"./B56Nm3vt.js";import{_ as Le}from"./Cie-o9Wa.js";import{_ as Pe}from"./CiVwig2f.js";import{q as qe,r as De,p as Oe}from"./Dm8J87dm.js";import{u as Qe}from"./RA92o3C4.js";import"./BMSQkwth.js";import"./DaWZu8wl.js";import"./abPSHzII.js";import"./5wIHoxV5.js";import"./o4ws_w_T.js";import"./DbqqhwXM.js";import"./DNSLGqNg.js";import"./psimjGaX.js";import"./CuVAPZQ8.js";import"./B3rWqoNg.js";import"./EK7Wbu3-.js";import"./RPflLnqr.js";import"./TrJvDfxI.js";import"./jsPNKUA0.js";import"./gaGwb9HC.js";import"./DUoaAyrs.js";import"./CnxT3uvZ.js";import"./DBiaUVBh.js";import"./hsuWSsy6.js";import"./DMoqg0Fd.js";import"./CtosDvS0.js";import"./kRIii9yh.js";import"./Z7qkLoXK.js";import"./C6Y-ieo6.js";import"./BFo3vNrE.js";import"./DeCyaT7k.js";import"./D4e4FYoF.js";import"./BCcN9pii.js";import"./CMKSl-Ng.js";import"./CxvgZo8z.js";import"./4jjeIyfe.js";import"./cd55qm53.js";import"./D7VOTB3C.js";import"./fhkze2Jn.js";import"./9Q2Y_nd6.js";import"./td2xDKru.js";import"./CRu9at2N.js";const ze={class:"flex h-full min-h-0 w-full flex-col"},Ne={key:0,class:"flex flex-col gap-2"},He={class:"text-muted-foreground text-sm"},je={key:0,class:"flex items-center gap-2"},We={class:"my-2 flex items-center gap-1"},Ge={class:"text-muted-foreground flex-none text-xs"},Je={key:1,class:"mt-2 flex items-center gap-1"},Ke={class:"text-muted-foreground flex-none text-xs"},Xe={key:0,class:"m-2 space-y-2"},Ze={class:"px-4 pb-4"},Ye={class:"flex gap-2 pb-4"},Wt=ye({__name:"preview-chat",props:{agent:{},showVariableInput:{type:Boolean}},emits:["update:agent"],setup(s,{expose:W,emit:G}){const J=L(()=>q(()=>import("./Crk5Dp68.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39]),import.meta.url)),K=L(()=>q(()=>import("./Bu9SiL2T.js"),__vite__mapDeps([40,41,1,42,43,31,32,33,13,18,11,34,35,36,21]),import.meta.url)),X=L(()=>q(()=>import("./DlQqvcQS.js"),__vite__mapDeps([44,45,1,3,4,2,46,8,28,10,13,14,15,11,47,18,30,39,26]),import.meta.url)),Z=G,Y=s,{params:ee}=ke(),te=Q(),{t:i}=Ce(),I=be(),b=we("scrollAreaRef"),{height:ae}=xe(b),D=Ie(),o=Fe(Y,"agent",Z),_=z(()=>ee.id),R=E(null),ne=[],F=E(null),oe=async()=>{if(o.value.createMode==="dify"&&_.value)try{F.value=await De(_.value)}catch{F.value=null}else F.value=null};N(()=>o.value.createMode,()=>oe(),{immediate:!0});const re=E([]),{messages:u,input:V,files:$,handleSubmit:se,reload:ie,stop:le,status:ce,error:ue}=Qe({api:qe,initialMessages:ne,chatConfig:{get avatar(){return o.value.chatAvatar}},body:{agentId:_.value,saveConversation:!1,get conversationId(){return R.value},get modelConfig(){return o.value.modelConfig},get mcpServerIds(){return o.value.mcpServerIds},get datasetIds(){return o.value.datasetIds},get rolePrompt(){return o.value.rolePrompt},get showContext(){return o.value.showContext},get showReference(){return o.value.showReference},get enableFeedback(){return o.value.enableFeedback},get autoQuestions(){return o.value.autoQuestions},get formFields(){return o.value.formFields},get formFieldsInputs(){return o.value.formFieldsInputs},get quickCommands(){return o.value.quickCommands},get thirdPartyIntegration(){return o.value.thirdPartyIntegration}},onToolCall(){},onResponse(a){a.status===401&&Q().logout(!0)},onUpdate(a){a.type==="conversation_id"&&(R.value=a.data)},onError(a){const t=a?.message||"发送失败";console.error("聊天错误:",t)},onFinish(){}}),S=z(()=>ce.value==="loading"),B=E(!0);function U(a){const t=a.target,m=40;B.value=t.scrollHeight-(t.scrollTop+t.clientHeight)<=m}async function w(a=!0){await H(),b.value?.scrollToBottom(a)}async function A(a){if(!a.trim()||S.value)return;if(!o.value.modelConfig?.id&&o.value.createMode==="direct")return I.warning(i("ai-agent.backend.configuration.modelNotConfigured"));const t=o.value.formFields||[],m=o.value.formFieldsInputs||{};if(t.length>0){const l=[];if(t.forEach(y=>{if(y.required){const x=m[y.name];(!x||typeof x=="string"&&x.trim()==="")&&l.push(`${y.label}${i("ai-agent.backend.configuration.notEmpty")}`)}}),l.length>0){I.error(`${i("ai-agent.backend.configuration.formVariableTitle")}: ${l.join(", ")}`);return}}await se(a),w()}const me=a=>{re.value=a,D.create(K).open({context:a})},de=(a,t=null)=>{D.create(J).open({agentId:_.value,annotationId:a,messageId:t,hiddenStatus:!0})};async function fe(a,t){const m=u.value[t-1];if(!m||m.role!=="user"){I.error(i("ai-agent.backend.configuration.noUserQuestion"));return}try{const l=await Oe(_.value,{agentId:_.value,question:m.content.toString(),answer:a.content.toString(),enabled:!0,messageId:a.id});u.value[t]?.metadata||u.value[t]&&(u.value[t].metadata={}),u.value[t]?.metadata&&(u.value[t].metadata.annotations={annotationId:l.id,createdBy:te.userInfo?.nickname,question:l.question,similarity:1})}catch(l){console.error("创建标注失败:",l)}}N(()=>u.value.at(-1)?.content,()=>H(()=>{B.value&&w(!1)}),{flush:"post"});let T=null;return Se(async()=>{w(!1);const a=b.value?.getViewportElement(),t=a&&a.viewportElement;t?.addEventListener("scroll",U,{passive:!0}),t&&(U({target:t}),T=new MutationObserver(()=>{B.value&&w(!1)}),T.observe(t,{childList:!0,subtree:!0,characterData:!0}))}),Ae(()=>{const a=b.value?.getViewportElement();(a&&a.viewportElement)?.removeEventListener("scroll",U),T?.disconnect()}),W({clearRecord(){u.value=[],R.value=null}}),(a,t)=>{const m=Ve,l=Ee,y=Be,x=Me,O=Ue,pe=Te,ge=$e,ve=Le,he=Re,_e=Pe;return r(),c("div",ze,[s.showVariableInput&&n(o).formFields&&n(o).formFields.length>0?(r(),k(n(X),{key:0,inputs:n(o).formFieldsInputs,"onUpdate:inputs":t[0]||(t[0]=e=>n(o).formFieldsInputs=e),formFields:n(o).formFields,class:"mx-4 mt-2",formClass:"bg-muted hover:bg-muted"},null,8,["inputs","formFields"])):f("",!0),d(ve,{class:"min-h-0 w-full flex-1",type:"auto",ref_key:"scrollAreaRef",ref:b,onInView:t[1]||(t[1]=e=>w(!1))},{default:v(()=>[d(ge,{loading:!1,"has-more":!1,threshold:500,"content-class":"w-full space-y-3 p-4 "},{default:v(()=>[n(u).length===0?(r(),k(y,{key:0,messages:[{role:"assistant",avatar:s.agent.chatAvatar,content:s.agent.openingStatement}],"scroll-area-height":200,assistant:{actions:[]}},{content:v(({message:e})=>[d(m,{content:e.content.toString(),class:"mb-2"},null,8,["content"]),s.agent.openingQuestions.length>0?(r(),c("div",Ne,[g("div",He,C(n(i)("ai-agent.backend.configuration.youCanAskMe")),1),(r(!0),c(M,null,P(s.agent.openingQuestions,p=>(r(),c("div",{key:p},[d(l,{label:p,color:"primary",variant:"soft",onClick:h=>A(p)},null,8,["label","onClick"])]))),128))])):f("",!0)]),_:1},8,["messages"])):(r(),k(y,{key:1,messages:n(u),"scroll-area-height":n(ae),error:n(ue),assistant:{actions:[{label:n(i)("ai-chat.frontend.messages.retry"),icon:"i-lucide-rotate-cw-square",onClick:()=>n(ie)()},{label:n(i)("ai-agent.backend.configuration.chatContext"),icon:"i-lucide-file-type",show:!s.agent.showContext,onClick:e=>{e?.metadata?.context?me(e.metadata.context):n(I).error(n(i)("ai-agent.backend.configuration.noChatContext"))}},{label:n(i)("ai-agent.backend.configuration.feedback"),icon:"i-lucide-wrap-text",show:!s.agent.enableFeedback,onClick:(e,p)=>{const h=e.metadata?.annotations?.annotationId;h?de(h,e.id):fe(e,p)}}]},"spacing-offset":160},{content:v(({message:e})=>[e.content.length||e.metadata?.references&&e.metadata.references.length?(r(),k(m,{key:0,content:e.content.toString()},{before:v(()=>[e.status==="loading"?(r(),c("div",je,[d(x,{name:"i-lucide-loader-2",class:"animate-spin"}),g("span",null,C(n(i)("ai-chat.frontend.messages.thinking")),1)])):f("",!0)]),after:v(()=>[e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"&&!n(S)&&s.agent.showReference?(r(),c(M,{key:0},[g("div",We,[g("span",Ge,C(n(i)("ai-agent.backend.configuration.referenceTitle")),1),e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"?(r(),k(O,{key:0,size:"xs",type:"dashed"})):f("",!0)]),d(pe,{references:e.metadata.references},null,8,["references"])],64)):f("",!0),e.metadata?.annotations&&e.role==="assistant"&&!n(S)?(r(),c("div",Je,[g("span",Ke,C(e.metadata?.annotations?.createdBy)+" "+C(n(i)("ai-agent.backend.configuration.editedAnswer")),1),d(O,{size:"xs",type:"dashed"})])):f("",!0)]),_:2},1032,["content"])):f("",!0)]),"after-tools":v(({message:e,index:p})=>[e.metadata?.suggestions&&n(u).length-1===p?(r(),c("div",Xe,[(r(!0),c(M,null,P(e.metadata.suggestions,h=>(r(),c("div",{key:h},[d(l,{label:h,color:"primary",variant:"soft",onClick:et=>A(h)},null,8,["label","onClick"])]))),128))])):f("",!0)]),_:1},8,["messages","scroll-area-height","error","assistant"]))]),_:1})]),_:1},512),g("div",Ze,[g("div",Ye,[(r(!0),c(M,null,P(s.agent.quickCommands,e=>(r(),c("div",{key:e.name},[d(l,{color:"neutral",variant:"soft",onClick:p=>A(e.name)},{default:v(()=>[e.avatar?(r(),k(he,{key:0,src:e.avatar,class:"h-4 w-4"},null,8,["src"])):f("",!0),g("span",null,C(e.name),1)]),_:2},1032,["onClick"])]))),128))]),d(_e,{modelValue:n(V),"onUpdate:modelValue":t[2]||(t[2]=e=>j(V)?V.value=e:null),"file-list":n($),"onUpdate:fileList":t[3]||(t[3]=e=>j($)?$.value=e:null),"is-loading":n(S),"model-config":s.agent.modelConfig,"agent-create-mode":s.agent.createMode,"file-upload-config":n(F)??void 0,class:"sticky bottom-0 z-10 [view-transition-name:chat-prompt]",onStop:n(le),onSubmit:A},null,8,["modelValue","file-list","is-loading","model-config","agent-create-mode","file-upload-config","onStop"])])])}}});export{Wt as default};
