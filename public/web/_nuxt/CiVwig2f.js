import{_ as me}from"./5wIHoxV5.js";import pe from"./4jjeIyfe.js";import{d as Z,k as ee,s as I,at as G,i as K,n as z,p as te,f as V,o as E,w as L,t as _,_ as oe,g as s,v as $,x as C,z as X,D as W,A as fe,l as ge,a8 as ve,j as he,cE as xe,aW as q,aN as ye,q as be,J as we,c as Fe,y as _e,r as M,C as J,ar as Ue}from"#entry";import{_ as se}from"./DbqqhwXM.js";import Ce from"./cd55qm53.js";import{_ as Te}from"./shdu-Ndv.js";import{_ as Le}from"./hsuWSsy6.js";import{k as Se,l as ze}from"./D7VOTB3C.js";import{u as ke}from"./fhkze2Jn.js";import{u as Y}from"./9Q2Y_nd6.js";import{u as Re}from"./CRu9at2N.js";import{_ as $e}from"./abPSHzII.js";const Oe={class:"text-background text-xs whitespace-pre-line"},je={class:"p-3"},Ee={class:"flex items-center gap-2"},Ie=["accept","disabled"],Me=Z({__name:"prompt-file-upload",props:{disabled:{type:Boolean},maxSize:{},accept:{},modelConfig:{},modelFeatures:{},agentCreateMode:{},fileUploadConfig:{}},emits:["file-select","url-submit"],setup(e,{emit:g}){const c=g,n=e,U=ke(),k=ee("fileInputRefs"),r=I(""),v=I(!1),p=G(),{t:b}=K(),w=I([]),R=z(()=>n.modelFeatures?.length?n.modelFeatures:w.value.length>0?w.value:n.modelConfig?.options?.features?.length?n.modelConfig.options.features:U.selectedModel?.features||[]),T=async i=>{if(n.modelFeatures?.length){w.value=[];return}if(!i){w.value=[];return}try{const a=await Se(i);w.value=a?.features||[]}catch(a){console.error("获取模型信息失败:",a),w.value=[]}};te(()=>n.modelConfig?.id,i=>T(i),{immediate:!0});const d={document:[".pdf",".docx",".doc",".txt",".md",".rtf",".csv",".xlsx",".xls",".pptx"],image:[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg"],audio:[".mp3",".wav",".flac",".aac",".ogg",".m4a"],video:[".mp4",".avi",".mov",".wmv",".flv",".webm",".mkv"]},t=z(()=>{if(n.agentCreateMode==="coze")return[...d.document,...d.image,...d.audio,...d.video].join(",");if(n.agentCreateMode==="dify"&&n.fileUploadConfig){const u=n.fileUploadConfig;if(u.enabled===!1)return"";if(u.allowedFileExtensions?.length)return u.allowedFileExtensions.map(m=>m.startsWith(".")?m:`.${m}`).join(",");if(u.allowedFileTypes?.length){const m=[];for(const S of u.allowedFileTypes){const y=S.toLowerCase();(y==="image"||y.includes("image"))&&m.push(...d.image),(y==="document"||y.includes("document"))&&m.push(...d.document),(y==="audio"||y.includes("audio"))&&m.push(...d.audio),(y==="video"||y.includes("video"))&&m.push(...d.video)}if(m.length)return[...new Set(m)].join(",")}return[...d.document,...d.image].join(",")}if(!n.modelFeatures?.length&&!n.modelConfig&&!U.selectedModel)return".pdf,.doc,.docx,.txt,.md";const i=R.value||[],a=[];return a.push(...d.document),i.includes("vision")&&a.push(...d.image),i.includes("audio")&&a.push(...d.audio),a.join(",")}),o=z(()=>{const a=n.maxSize||100,u=R.value.includes("vision"),m=b("common.chat.messages.uploadAttachmentTextOnly"),S=b("common.chat.messages.fileUploadLimit",{count:10,size:a}),y=u?b("common.chat.messages.supportsImage"):"";return`${m}
${S}${y}`}),f=()=>{v.value=!1,k.value?.click()};function h(i){const a=i.target,u=a.files?.[0];u&&c("file-select",u),a.value=""}function x(i){try{const m=new URL(i).pathname.split(".").pop()?.toLowerCase()||"";return m?`.${m}`:""}catch{const a=i.split(".").pop()?.toLowerCase()||"";return a?`.${a}`:""}}function P(i){return i?t.value.split(",").map(u=>u.trim()).includes(i.toLowerCase()):!1}function A(){const i=r.value.trim();if(!i)return;try{new URL(i)}catch{p.error(b("common.message.invalidUrl"));return}const a=x(i);if(!P(a)){p.error(b("common.message.unsupportedFileType"));return}c("url-submit",i),r.value="",v.value=!1}return(i,a)=>{const u=oe,m=se,S=Ce,y=Te,N=Le;return E(),V(N,{open:s(v),"onUpdate:open":a[2]||(a[2]=O=>W(v)?v.value=O:null)},{content:L(()=>[C("div",je,[C("div",null,[_(S,{modelValue:s(r),"onUpdate:modelValue":a[1]||(a[1]=O=>W(r)?r.value=O:null),ui:{root:"w-full",trailing:"!pe-0 !pr-1"},placeholder:s(b)("common.chat.messages.inputUrlPlaceholder")},{trailing:L(()=>[_(u,{size:"xs",onClick:$(A,["stop"])},{default:L(()=>[fe(X(s(b)("common.confirm")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),_(y,{class:"my-2",ui:{container:"text-xs font-normal text-muted-foreground"},label:"OR"}),C("div",Ee,[_(u,{size:"sm",label:s(b)("common.upload"),ui:{base:"flex-1 justify-center"},icon:"i-lucide-cloud-upload",variant:"outline",disabled:e.disabled,onClick:f},null,8,["label","disabled"])]),C("input",{ref_key:"fileInputRefs",ref:k,type:"file",accept:e.accept||s(t),class:"hidden",disabled:e.disabled,onChange:h},null,40,Ie)])]),default:L(()=>[_(m,{"delay-duration":0,ui:{content:"w-xs h-auto"}},{content:L(()=>[C("div",Oe,X(s(o)),1)]),default:L(()=>[_(u,{onClick:a[0]||(a[0]=$(()=>{},["stop"])),size:"lg",variant:"ghost",icon:"i-lucide-paperclip",class:"rounded-full font-bold",disabled:e.disabled||!s(t)},null,8,["disabled"])]),_:1})]),_:1},8,["open"])}}}),Ve=["jpg","jpeg","png","gif","bmp","webp","svg"],Pe=["mp4","webm","ogg","mov","avi","wmv","flv","mkv"],Ae=["mp3","wav","ogg","m4a","aac","flac","wma"],Ne=e=>e.extension?e.extension.toLowerCase():(e.name||e.originalName||"").split(".").pop()?.toLowerCase()||"",Q=(e,g,c)=>{const n=Ne(e),U=e.type?.toLowerCase()||"";return g.includes(n)||U.startsWith(c)},Be=e=>Q(e,Ve,"image/"),De=e=>Q(e,Pe,"video/"),We=e=>Q(e,Ae,"audio/"),H=e=>Be(e)?"image":De(e)?"video":We(e)?"audio":"file";function Ge(){const{t:e}=K(),g=G(),c=ge([]),n=z(()=>c.value.some(t=>t.status==="uploading")),U=()=>`${Date.now()}-${Math.random().toString(36).slice(2,11)}`,k=t=>c.value.find(o=>o.id===t),r=(t,o)=>{const f=k(t);f&&Object.assign(f,o)},v=t=>{t.startsWith("blob:")&&URL.revokeObjectURL(t)},p=async t=>{const o=U(),f=URL.createObjectURL(t);c.value.push({id:o,name:t.name,size:t.size,url:f,progress:0,status:"uploading",mediaType:H(t),file:t});try{const h=await Y({file:t,description:`Prompt file: ${t.name}`},{onProgress:x=>r(o,{progress:x})});return v(f),r(o,{status:"success",progress:100,url:h.url,result:h}),g.success(e("common.message.uploadSuccess")),h}catch(h){return console.error("File upload failed:",h),r(o,{status:"error",error:h instanceof Error?h.message:e("common.message.uploadFailed")}),g.error(e("common.message.uploadFailed")),null}},b=async t=>{try{new URL(t.trim())}catch{return g.error(e("common.message.invalidUrl")),!1}const o=`url-${U()}`,f=t.trim(),h=f.split("/").pop()||"Remote File";c.value.push({id:o,name:h,size:0,url:f,progress:0,status:"uploading",mediaType:"image"});try{const x=await Re({url:f,description:`Remote file: ${h}`});return r(o,{status:"success",progress:100,url:x.url,size:x.size,name:x.originalName,mediaType:H(x),result:x}),g.success(e("common.message.urlAdded")),!0}catch(x){return r(o,{status:"error",error:x instanceof Error?x.message:e("common.message.uploadFailed")}),g.error(e("common.message.uploadFailed")),!1}},w=t=>{const o=c.value.findIndex(f=>f.id===t.id);o!==-1&&(v(c.value[o]?.url??""),c.value.splice(o,1))},R=()=>{c.value.forEach(t=>v(t.url)),c.value=[]},T=async t=>{if(!t.file)return g.error(e("common.message.fileNotFound")),null;Object.assign(t,{status:"uploading",progress:0,error:void 0});try{const o=await Y({file:t.file,description:`Prompt file: ${t.file.name}`},{onProgress:f=>t.progress=f});return v(t.url),Object.assign(t,{status:"success",progress:100,url:o.url,result:o}),g.success(e("common.message.uploadSuccess")),o}catch(o){return console.error("File upload failed:",o),Object.assign(t,{status:"error",error:o instanceof Error?o.message:e("common.message.uploadFailed")}),g.error(e("common.message.uploadFailed")),null}},d=()=>c.value.filter(t=>t.status==="success"&&t.result).map(t=>{switch(t.mediaType){case"image":return{type:"image_url",image_url:{url:t.url}};case"video":return{type:"video_url",video_url:{url:t.url}};case"audio":{const o=t.name.split(".").pop()?.toLowerCase()||"mp3";return{type:"input_audio",input_audio:{data:t.url,format:o}}}default:return{type:"file_url",name:t.name,url:t.url}}});return{files:ve(c),isUploading:n,uploadFile:p,addUrl:b,removeFile:w,clearFiles:R,retryUpload:T,generateFilesList:d}}const Ke={class:"flex items-center gap-2"},Qe={class:"flex items-end justify-between p-0 sm:p-2"},Xe={class:"flex items-center gap-2"},qe={class:"flex items-center gap-2"},Je=Z({__name:"chats-prompt",props:{modelValue:{default:""},fileList:{default:()=>[]},placeholder:{default:""},isLoading:{type:Boolean,default:!1},rows:{default:1},needAuth:{type:Boolean,default:!1},attachmentSizeLimit:{default:10},modelConfig:{},modelFeatures:{},agentCreateMode:{},fileUploadConfig:{}},emits:["update:modelValue","update:fileList","submit","stop"],setup(e,{emit:g}){const c=g,n=e,U=ee("uTextareaRefs"),k=z(()=>U.value?.textareaRef||null),r=q(n,"modelValue",c),v=q(n,"fileList",c),{t:p}=K(),b=he(),w=G(),{focused:R}=xe(k,{initialValue:!1}),T=I(""),d=I(""),t=z(()=>d.value!==""&&r.value.trim()===d.value.trim()),{files:o,isUploading:f,uploadFile:h,addUrl:x,removeFile:P,retryUpload:A,generateFilesList:i,clearFiles:a}=Ge(),u=z(()=>r.value.trim().length>0||o.value.length>0);function m(){U.value?.textareaRef?.focus(),!b.isAgreed&&n.needAuth&&Ue("/login")}function S(l){if(!l.isComposing&&l.key==="Enter"&&!l.shiftKey){if(l.preventDefault(),n.isLoading||!u.value)return;c("submit",r.value)}}function y(){if(n.isLoading)c("stop");else{if(!u.value)return;c("submit",r.value)}}async function N(l){await h(l)&&(v.value=i())}async function O(l){await x(l)&&(v.value=i())}function ae(l){"id"in l&&(P(l),v.value=i())}async function ne(l){"id"in l&&await A(l)&&(v.value=i())}const{lockFn:ie,isLock:j}=ye(async()=>{if(!r.value.trim()){w.warning(p("common.chat.messages.enterQuestion"));return}if(!n.isLoading)try{T.value=r.value.trim();const l=localStorage.getItem("modelId")||void 0,F=await ze({modelId:l,text:T.value});F.optimizedText?(d.value=F.optimizedText,r.value=F.optimizedText,w.success(p("common.chat.messages.optimizeSuccess"))):w.warning(p("common.chat.messages.optimizeEmpty"))}catch(l){console.error("文案优化失败:",l);const F=l?.message||p("common.chat.messages.optimizeFailed");w.error(F)}});function le(){T.value&&(r.value=T.value,d.value="",T.value="")}return te(()=>n.fileList,l=>{l.length===0&&o.value.length>0&&a()}),be(()=>we(()=>{b.isAgreed&&m()})),(l,F)=>{const re=me,ue=pe,B=oe,D=se,ce=Me;return E(),Fe("div",{class:J(["chat-action-bar w-full rounded-md border p-1.5 transition-[border-color_box-shadow] duration-200 sm:rounded-2xl",s(R)?"ring-primary/15 border-primary ring-3":"border-border"]),onClick:$(m,["stop"])},[C("div",Ke,[M(l.$slots,"panel-top",{},void 0,!0)]),s(o).length>0?(E(),V(re,{key:0,files:[...s(o)],"show-actions":!0,class:"p-1.5",onRemove:ae,onRetry:ne},null,8,["files"])):_e("",!0),_(ue,{ref_key:"uTextareaRefs",ref:U,modelValue:s(r),"onUpdate:modelValue":F[0]||(F[0]=de=>W(r)?r.value=de:null),class:J(["custom-textarea-wrapper w-full",{"optimizing-text":s(j)}]),style:{"--ui-bg-elevated":"var(--color-background)"},variant:"ghost",rows:e.rows,maxrows:8,highlight:!1,autoresize:!0,ui:{base:"resize-none custom-textarea text-base min-h-[40px] focus:bg-transparent hover:bg-transparent"},placeholder:e.placeholder||s(p)("common.chat.messages.inputPlaceholder"),disabled:s(j),onKeydown:S},null,8,["modelValue","class","rows","placeholder","disabled"]),C("div",Qe,[C("div",Xe,[M(l.$slots,"panel-left",{},()=>[F[1]||(F[1]=C("div",null,null,-1))],!0)]),M(l.$slots,"panel-right",{},()=>[C("div",qe,[s(t)?(E(),V(D,{key:0,text:s(p)("common.chat.messages.revertText"),"delay-duration":0,arrow:!0},{default:L(()=>[_(B,{icon:"i-lucide-undo-2",class:"rounded-full font-bold",size:"lg",variant:"ghost",color:"primary",disabled:n.isLoading,onClick:$(le,["stop"])},null,8,["disabled"])]),_:1},8,["text"])):(E(),V(D,{key:1,text:s(j)?s(p)("common.chat.messages.optimizing"):s(r)?.trim()?s(p)("common.chat.messages.optimizeText"):s(p)("common.chat.messages.enterQuestion"),"delay-duration":0,arrow:!0},{default:L(()=>[_(B,{icon:"i-lucide-sparkles",class:"rounded-full font-bold",size:"lg",variant:"ghost",color:"primary",disabled:s(j)||!s(r)?.trim()||n.isLoading,loading:s(j),onClick:$(s(ie),["stop"])},null,8,["disabled","loading","onClick"])]),_:1},8,["text"])),_(ce,{disabled:s(f),maxSize:e.attachmentSizeLimit,"model-config":e.modelConfig,"model-features":e.modelFeatures,"agent-create-mode":e.agentCreateMode,"file-upload-config":e.fileUploadConfig,onFileSelect:N,onUrlSubmit:O},null,8,["disabled","maxSize","model-config","model-features","agent-create-mode","file-upload-config"]),M(l.$slots,"panel-right-item",{},void 0,!0),_(D,{content:{align:"center",side:"top",sideOffset:8},text:e.isLoading?s(p)("common.chat.messages.stopGeneration"):s(u)?s(p)("common.chat.messages.sendMessage"):s(p)("common.chat.messages.enterQuestion"),"delay-duration":0,arrow:!0,disabled:e.isLoading||s(u)},{default:L(()=>[_(B,{icon:e.isLoading?"i-lucide-square":"i-lucide-arrow-up",class:"rounded-full font-bold",size:"lg",disabled:!e.isLoading&&!s(u),color:e.isLoading?"error":"primary",onClick:$(y,["stop"])},null,8,["icon","disabled","color"])]),_:1},8,["text","disabled"])])],!0)])],2)}}}),Ye=$e(Je,[["__scopeId","data-v-609997a7"]]),ct=Object.freeze(Object.defineProperty({__proto__:null,default:Ye},Symbol.toStringTag,{value:"Module"}));export{Ye as _,We as a,ct as c,H as g,De as i};
