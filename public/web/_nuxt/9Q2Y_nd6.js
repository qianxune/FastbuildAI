import{as as m,aj as g,c6 as w,c7 as h}from"#entry";import{S}from"./td2xDKru.js";function O(t,n){const i=new Set(Array.isArray(n)?n:[n]);return Object.fromEntries(Object.entries(t).filter(([o])=>!i.has(o)))}function y(t){if(t)return t;try{return m().public.pluginName}catch{return}}async function x({file:t,...n},i){const o=g();try{const{signature:e,fullPath:u,fileUrl:p,metadata:c}=await o.getOSSSignature(n),s=new FormData;s.append("key",u),s.append("success_action_status","200"),s.append("policy",e.policy),s.append("x-oss-signature",e.signature),s.append("x-oss-signature-version",e.ossSignatureVersion),s.append("x-oss-credential",e.ossCredential),s.append("x-oss-date",e.ossDate),s.append("x-oss-security-token",e.securityToken),s.append("file",t);const a=new XMLHttpRequest;return new Promise((f,d)=>{i?.onProgress&&a.upload.addEventListener("progress",r=>{if(r.lengthComputable){const l=Math.round(r.loaded/r.total*100);i.onProgress?.(l,r.loaded)}}),a.addEventListener("load",async()=>{if(a.status>=200&&a.status<300)try{const r=y(n.extensionId),l=await w({url:p,originalName:c.originalName,size:c.size,extension:c.extension,type:c.type,path:u,extensionId:r});f(l)}catch(r){console.error("[Upload] Failed to save OSS file record:",r),f({id:"",type:c.type||"",url:p,originalName:c.originalName,size:c.size,extension:c.extension})}else{const r=new Error(`OSS upload failed: ${a.status} ${a.statusText}`);d(r)}}),a.addEventListener("error",()=>{const r=new Error("OSS upload network error");d(r)}),a.addEventListener("abort",()=>{const r=new Error("OSS upload has been cancelled");d(r)}),a.open("POST",e.host),a.send(s)})}catch(e){throw console.error("[Upload] OSS upload failed: ",e),e}}async function P(t,n){return t.files.reduce((o,e)=>o+e.size,0),await Promise.all(t.files.map(o=>{const e={file:o,size:o.size,name:o.name};return t.extensionId&&(e.extensionId=t.extensionId),n?.onProgress,x(e)}))}async function E(t,n){const i=g();try{let o=i.storageType;switch(o||(o=await i.checkStorageType()),o){case S.OSS:{const e=y(t.extensionId);return await x({...O(t,"description"),...e&&{extensionId:e},name:t.file.name,size:t.file.size},n)}case S.LOCAL:return await h(t,n)}return Promise.reject("Invalid storage type")}catch(o){throw console.error("[Upload] upload failed:",o),o}}export{P as a,x as f,y as g,O as o,E as u};
